// Author: Henry McDaniel / henry@sunsetrainbow.com
// Simple tool for applying basic shadows to SVG elements.
csstosvg={},csstosvg.Internal=function(e,t){return self.Data={initialized:!1},self.Utility={perror:function(e){window.console&&window.console.log("csstosvg: "+e)},init:function(){self.Data.initialized=!0},sanityCheck:function(){return self.init(),self.Data.initialized},getRootSVG:function(e){var t=0;return t=e&&e[0]&&e[0][0]?e[0][0].ownerSVGElement:e.parentElement},attr:function(e,t){var r=0;return r="function"==typeof e.attr?e.attr(t):e.getAttribute(t)},setAttr:function(e,t,r){"function"==typeof e.attr?e.attr(t,r):e.setAttribute(t,r)}},self.Parse={isPercent:function(e){return"%"===e[e.length-1]?!0:!1},isNumeric:function(e){return"0"==e[0]||"-"==e[0]||parseInt(e)?!0:!1},color:function(e){var t="",r=1,l="";if(e.length<3)l="string too short";else if(e.indexOf("rgb(")>-1||e.indexOf("rgba(")>-1){e=e.replace(/(rgb\(|rgba\(|\)|;|\s)/gi,"");var i=e.split(",");if(i&&i.length>2){t="rgb(";for(var n=0;3>n;n++){if(!self.Parse.isNumeric(i[n])){l="rgb color value ["+i[n]+"] is not a number";break}t+=i[n]+(2>n?",":"")}t+=")",4==i.length&&(r=i[3],self.Parse.isNumeric(r)||(l="opacity ["+r+"] is not a number"))}else l="too few/many parts"}else t=";"==e[e.length-1]?e.substring(0,e.length-1):e;var o={color:t,opacity:r,error:l};return o},cssLineSplit:function(e){var t=e.replace(/(px|\%|\))\s*,/gi,"$1").split("");return t}},self.SVG={getNameSpace:function(){return"http://www.w3.org/2000/svg"},createElement:function(e,t){var r=document.createElementNS(e,t);return r},createShadow:function(e){var t,r=e.c,l=e.p,i=e.addToFilter,n=e.i,o=e.input?e.input:"SourceGraphic",s=self.SVG.getNameSpace(),a=!1,u=r.getElementsByTagName("defs");u&&u.length?t=u[u.length-1]:(t=self.SVG.createElement(s,"defs"),a=!0);var f=0,d=o,c="",p="SourceAlpha",S="SourceAlpha";i?f=i:(f=self.SVG.createElement(s,"filter"),f.setAttributeNS(null,"id",l.id)),l.negX&&f.setAttributeNS(null,"x",l.negX),l.negY&&f.setAttributeNS(null,"y",l.negY),obj.width&&f.setAttributeNS(null,"width",obj.width),obj.height&&f.setAttributeNS(null,"height",obj.height);var b=self.SVG.createElement(s,"feGaussianBlur");b.setAttributeNS(null,"in",S),b.setAttributeNS(null,"stdDeviation",obj.deviation),console.log(obj.deviation);var h=self.SVG.createElement(s,"feOffset");if(h.setAttributeNS(null,"dx",l.dx),h.setAttributeNS(null,"dy",l.dy),l.inset===!1){c="offsetblur"+n,h.setAttributeNS(null,"result",c);var g=self.SVG.createElement(s,"feFlood");g.setAttributeNS(null,"flood-color",l.color),g.setAttributeNS(null,"flood-opacity",l.opacity);var v=self.SVG.createElement(s,"feComposite");v.setAttributeNS(null,"in2",c),v.setAttributeNS(null,"operator","in");var m=self.SVG.createElement(s,"feMerge"),N=self.SVG.createElement(s,"feMergeNode"),A=self.SVG.createElement(s,"feMergeNode");A.setAttributeNS(null,"in",d),f.appendChild(b),f.appendChild(h),f.appendChild(g),f.appendChild(v),m.appendChild(N),m.appendChild(A),f.appendChild(m)}else{b.setAttributeNS(null,"result","blur"+n);var y=self.SVG.createElement(s,"feComposite");y.setAttributeNS(null,"in2",p),y.setAttributeNS(null,"operator","arithmetic"),y.setAttributeNS(null,"k2",-1.4),y.setAttributeNS(null,"k3",1.4),c="shadowDiff"+n,y.setAttributeNS(null,"result",c);var g=self.SVG.createElement(s,"feFlood");g.setAttributeNS(null,"flood-color",l.color),g.setAttributeNS(null,"flood-opacity",l.opacity);var w=self.SVG.createElement(s,"feComposite");w.setAttributeNS(null,"in2",c),w.setAttributeNS(null,"operator","in");var C=self.SVG.createElement(s,"feComposite");C.setAttributeNS(null,"in2",d),C.setAttributeNS(null,"operator","over"),f.appendChild(b),f.appendChild(h),f.appendChild(y),f.appendChild(g),f.appendChild(w),f.appendChild(C)}return t.appendChild(f),a===!0&&r.appendChild(t),{result:c,filter:f}}},self.CSS={boxShadowTriplet:function(e){var t,r,l=e.split(" "),i={offsetX:{require:!0,number:!0,def:0},offsetY:{require:!0,number:!0,def:0},blurRadius:{require:!1,number:!0,percentAllowed:!0,def:"100%"},spreadRadius:{require:!1,number:!0,percentAllowed:!0,def:"0"},color:{require:!1,number:!1,color:!0,def:""}},n=0,o={inset:!1},s=0,a=0;for(var u in i)if(o[u]=i[u].def,!s&&n<l.length){if(r=l[n],!r){for(;n<l.length&&!l[n];)n++;if(n>=l.length)break;r=l[n]}if(!a){if("none"===r){o.none=!0;break}"inset"===r&&(o.inset=!0,n++,r=l[n])}if(t=self.Parse.isNumeric(r))i[u].percentAllowed&&self.Parse.isPercent(r)||(r=parseInt(r));else if(i[u].number){if(!i[u].required)continue;s++,self.Utility.perror('number expected. instead got: "'+r+'"')}else if(i[u].color){var f=self.Parse.color(r);s+=f.error?1:0,s&&self.Utility.perror("malformed: "+f.error+' IN "'+r+'"'),r=f.color,o.opacity=f.opacity}a++,o[u]=r,n++}return o.error=s,o},INboxShadow:function(e){var t={error:0,group:[]},r=self.Parse.cssLineSplit(e);console.log(r);for(var l=0;l<r.length;l++)t.group[l]=self.CSS.boxShadowTriplet(r[l]),t.error+=t.group[l].error;return t},OUTboxShadow:function(e,t,r){if(!r.error){for(var l,i=self.Utility.attr(t,"id"),n="csstosvg-"+(i?i:Math.floor(1e6*Math.random())),o=!1,s=!1,a=0;a<r.group.length;a++){l=r.group[a],console.log(l);var u=l.opacity?l.opacity:1,f="-100%",d="-100%",c=300,p=1,S=0,b=self.Parse.isPercent(l.blurRadius);if((S=parseInt(self.Utility.attr(t,"r")))||(S=Math.round((self.Utility.attr(t,"width")+self.Utility.attr(t,"height"))/2)),l.blurRadius){var h=parseInt(l.blurRadius);p=b?Math.round(.5*h*S):.5*h}if(l.spreadRadius){var g=(parseInt(p),parseInt(l.spreadRadius)),v=self.Parse.isPercent(l.spreadRadius);p+=v?Math.round(.5*g*S):.5*g}l.inset===!0&&(f=0,d=0,c-=70,p=6.5);var m=c+"%",N=c+"%";obj={id:n,width:m,height:N,negX:f,negY:d,dx:l.offsetX,dy:l.offsetY,deviation:p,opacity:u,color:l.color,inset:l.inset,spread:g};var A={c:e,p:obj,addToFilter:o,i:a,input:s},y=self.SVG.createShadow(A);o=y.filter,s=y.result}self.Utility.setAttr(t,"filter","url(#"+n+")")}},process:function(e,t){var r=t.split(":"),l=r[0],i=l.length<t.length?t.substr(l.length+1):"",n=self.Utility.getRootSVG(e);return"box-shadow"===l&&self.CSS.OUTboxShadow(n,e,self.CSS.INboxShadow(i)),csstosvg}},self.CSS.process(e,t)},csstosvg.apply=csstosvg.Internal;
